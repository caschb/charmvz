#+TITLE: LabBook
#+AUTHOR: CharmVZ Authors
#+STARTUP: overview indent
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport

* Meetings
** 2025-05-02 Grab a preliminary output of projections' cli and do paje
:properties:
:header-args: :tangle charmvz_pipeline.sh :shebang #!/bin/bash
:end:
*** Header
#+begin_src shell :results output :exports both
OUTPUT="output.pj"
echo '%EventDef PajePushState 2
%       Time date
%       Container string
%       Type string
%       Value string
%EndEventDef
%EventDef PajePopState 3
%       Time date
%       Container string
%       Type string
%EndEventDef
%EventDef PajeCreateContainer 10
%       Time date
%       Type string
%       Name string
%       Container string
%EndEventDef
%EventDef PajeDestroyContainer 11
%       Time date
%       Type string
%       Name string
%EndEventDef
%EventDef PajeDefineContainerType 12
%       Name string
%       Type string
%EndEventDef
%EventDef PajeDefineVariableType 13
%       Alias string
%       Type string
%       Name string
%       Color color
%EndEventDef
%EventDef PajeDefineStateType 14
%       Name string
%       Type string
%EndEventDef
%EventDef PajeDefineEventType 15
%       Alias string
%       Type string
%       Name string
%EndEventDef
%EventDef PajeDefineLinkType 16
%       Alias string
%       Type string
%       StartContainerType string
%       EndContainerType string
%       Name string
%EndEventDef
%EventDef PajeDefineEntityValue 17
%       Alias string
%       Type string
%       Name string
%       Color color
%EndEventDef
#
# This is the type hierarchy
#
12 PE 0
14 STATE PE
#
# These are the events
#' > $OUTPUT
#+end_src

#+RESULTS:

*** Grab only the part that matters

#+begin_src shell :results output :exports both
TEMPFILE=mytempfile.aux
cat | \
    grep _PROCESSING | \
    cut -d, -f1,5,7,9 > ${TEMPFILE}
#+end_src

#+RESULTS:

*** Create Containers

#+begin_src shell :results output :exports both
PE_ELEMENTS=$(cat ${TEMPFILE} | cut -d, -f4 | sort | uniq)
echo ${PE_ELEMENTS}
for pe in ${PE_ELEMENTS}; do
    echo "10 0.0 PE pe${pe} 0"
done
#+end_src

#+RESULTS:
: 0

*** Events themselves (push and pops)

#+begin_src shell :results output :exports both
cat ${TEMPFILE} | \
    sed 's/,/ /g' | \
    awk '{ print $1 " " $2 " pe" $4 " STATE " $3 }' | \
    sed '/^3/ s/ [^ ]*$//' | \
    sort -S 50% --parallel=4 -T . -s -V --key=2,2
#+end_src

#+RESULTS:

*** Pjdump this thing to a CSV file

#+begin_src shell :results output :exports both
#OUTPUT="output.pj"
#CSV="output.csv"
#~/dev/pajeng/b13/pj_dump ${OUTPUT} | grep ^State > ${CSV}
#head ${CSV}
#+end_src

#+RESULTS:
#+begin_example
State, pe0, STATE, 26236.000000, 26264.000000, 28.000000, 0.000000, 157
State, pe0, STATE, 26268.000000, 26300.000000, 32.000000, 0.000000, 157
State, pe0, STATE, 26303.000000, 26338.000000, 35.000000, 0.000000, 157
State, pe0, STATE, 26340.000000, 26361.000000, 21.000000, 0.000000, 157
State, pe0, STATE, 26425.000000, 26430.000000, 5.000000, 0.000000, 0
State, pe0, STATE, 26479.000000, 26501.000000, 22.000000, 0.000000, 158
State, pe0, STATE, 26501.000000, 26503.000000, 2.000000, 0.000000, 179
State, pe0, STATE, 26503.000000, 26512.000000, 9.000000, 0.000000, 158
State, pe0, STATE, 26512.000000, 26513.000000, 1.000000, 0.000000, 179
State, pe0, STATE, 26513.000000, 26521.000000, 8.000000, 0.000000, 158
#+end_example

** Sample analysis with R
*** Read and plot

#+begin_src R :results output :session *R* :exports both :noweb yes :colnames yes
options(crayon.enabled=FALSE)
suppressMessages(library(tidyverse))
read_csv("output.csv", progress=FALSE, col_names=FALSE, show_col_types=FALSE) |>
  set_names("State", "Container", "Type", "Start", "End", "Duration", "Depth", "Value") |>
  mutate(Container = as.integer(gsub("pe", "", Container))) -> df
df |>
  ggplot(aes(xmin = Start, xmax = End, fill=as.factor(Value),
             ymin = Container, ymax = Container+1)) +
  geom_rect() +
  theme_bw(base_size=12) +  
  theme(
    panel.grid = element_blank(),
    plot.margin = unit(c(0,0,0,0), "cm"),
    legend.position="top",
    legend.justification = "left",
    legend.spacing = unit(0.5, "mm"),
    legend.box.spacing = unit(0, "pt"),
    legend.box.margin = margin(0,0,0,0),
    legend.margin=margin(t = 0, unit='cm'),
    legend.title = element_blank())
#+end_src

#+RESULTS:

*** How much time on each of these states

#+begin_src R :results output :session *R* :exports both :noweb yes :colnames yes
df |> select(End) |> slice(n()) |> pull(End) -> s.makespan

df |>
  group_by(Value) |>
  summarize(Duration.sum = sum(Duration)) |>
  mutate(P = Duration.sum / s.makespan * 100) |>
  arrange(-Duration.sum)
#+end_src

#+RESULTS:
#+begin_example
# A tibble: 32 × 3
   Value Duration.sum        P
   <dbl>        <dbl>    <dbl>
 1   185     25129563 62.6    
 2   184       695129  1.73   
 3   170       111078  0.277  
 4   181        80995  0.202  
 5     3        57241  0.143  
 6   172        15344  0.0382 
 7   174         6003  0.0149 
 8   171         5761  0.0143 
 9   159         3967  0.00988
10   165         2108  0.00525
# ℹ 22 more rows
# ℹ Use `print(n = ...)` to see more rows
#+end_example

*** How much idle time in a part of the traces that is really computing

#+begin_src R :results output :session *R* :exports both :noweb yes :colnames yes
df |>
  mutate(Next.Start = lead(Start)) |>
  mutate(Gap = Next.Start - End) |>
  filter(Gap != 0) |>
  arrange(-Gap) |>
  select(Gap, everything()) |>
  slice(3:n()) |>
  pull(Gap) |>
  sum() / s.makespan * 100
#+end_src

#+RESULTS:
: [1] 19.45842

*** Wrap-up
**** Trace processing part
- * Check why the dump is failing
- * Understand other important events on that dump
  - the migration phase / the load balancing check phase
- * To be able to identify which core a PE is part of
  - This hierarchy should be coded in Paje as well
- Provide a way to recode chare numbers to names
  - That can be very simply, only by reading with R/Python the STS
    file and doing a left-join
- The idea of generating a parquet file later on
  - We keep generating a CSV file for now
**** Experimental project
- * Run the leanMD application for real
  - You can use more than one machine
- Factors of this experimental project
  - schedulers,
  - the migration frequency,
  - the number of PEs,
  - oversubscription intensity
**** Open an overleaf with the CARLA conference format
- Put a structure of the document
  
